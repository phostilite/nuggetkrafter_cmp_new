{% extends '../base.html' %}
{% block content %}
{% load static %}    
{% include './navbar.html' %}
{% include './sidebar.html' %}

<div class="p-4 sm:ml-64 mt-14">
    <div class="p-4 dark:border-gray-700">
        <div class="relative overflow-x-auto ">
            <!-- Heading -->
            <h2 class="text-4xl font-bold dark:text-white mb-2.5">User: {{ user.first_name }} {{ user.last_name }}</h2>
            <!-- Breadcrumb -->
            <nav class="flex mb-2.5" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-2 rtl:space-x-reverse">
                    <li class="inline-flex items-center">
                        <a href="#" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-purple-600 dark:text-gray-400 dark:hover:text-white">
                        <svg class="w-3 h-3 me-2.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                            <path d="m19.707 9.293-2-2-7-7a1 1 0 0 0-1.414 0l-7 7-2 2a1 1 0 0 0 1.414 1.414L2 10.414V18a2 2 0 0 0 2 2h3a1 1 0 0 0 1-1v-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v4a1 1 0 0 0 1 1h3a2 2 0 0 0 2-2v-7.586l.293.293a1 1 0 0 0 1.414-1.414Z"/>
                        </svg>
                        Client's
                        </a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                            </svg>
                            <a href="#" class="ms-1 text-sm font-medium text-gray-700 hover:text-purple-600 md:ms-2 dark:text-gray-400 dark:hover:text-white">User</a>
                        </div>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                            </svg>
                            <a href="#" class="ms-1 text-sm font-medium text-gray-700 hover:text-purple-600 md:ms-2 dark:text-gray-400 dark:hover:text-white">Mapped SCORM</a>
                        </div>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                            </svg>
                            <a href="#" class="ms-1 text-sm font-medium text-gray-700 hover:text-purple-600 md:ms-2 dark:text-gray-400 dark:hover:text-white">Progress</a>
                        </div>
                    </li>
                </ol>
            </nav>
            <div class="flex justify-between">
                <h4 class="text-2xl font-bold dark:text-white">Report on SCORM: <span class="underline">{{ scorm.title }}</span></h4>
                <div>
                    {% if scorm_status.complete_status == 'Incomplete' %}
                        <a href="#" class="flex items-center p-3 text-base font-bold text-gray-900 rounded-lg bg-gray-50 hover:bg-gray-100 group hover:shadow dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="30" height="30" viewBox="0 0 48 48">
                                <defs><linearGradient id="0mN9JBqXHzFxUk_CVfC1Fa_Zyo5wDjgJxRW_gr1" x1="-792" x2="-792" y1="6" y2="42" gradientTransform="translate(816)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#ff8282"></stop><stop offset="1" stop-color="#d61313"></stop></linearGradient><radialGradient id="0mN9JBqXHzFxUk_CVfC1Fb_Zyo5wDjgJxRW_gr2" cx="-792" cy="24" r="18" gradientTransform="translate(816)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#ff7575" stop-opacity="0"></stop><stop offset=".406" stop-color="#fe7474" stop-opacity=".011"></stop><stop offset=".553" stop-color="#fa6f6f" stop-opacity=".052"></stop><stop offset=".657" stop-color="#f46767" stop-opacity=".123"></stop><stop offset=".741" stop-color="#eb5c5c" stop-opacity=".225"></stop><stop offset=".813" stop-color="#df4d4d" stop-opacity=".358"></stop><stop offset=".877" stop-color="#d13b3b" stop-opacity=".522"></stop><stop offset=".935" stop-color="#bf2525" stop-opacity=".717"></stop><stop offset=".987" stop-color="#ac0c0c" stop-opacity=".936"></stop><stop offset="1" stop-color="#a60505"></stop></radialGradient></defs><circle cx="24" cy="24" r="18" fill="url(#0mN9JBqXHzFxUk_CVfC1Fa_Zyo5wDjgJxRW_gr1)"></circle><circle cx="24" cy="24" r="18" fill="url(#0mN9JBqXHzFxUk_CVfC1Fb_Zyo5wDjgJxRW_gr2)" opacity=".8"></circle>
                            </svg>
                            <span class="flex-1 ms-3 whitespace-nowrap">INCOMPLETE</span>
                        </a>
                    {% elif scorm_status.complete_status == 'Passed' %}
                        <a href="#" class="flex items-center p-3 text-base font-bold text-gray-900 rounded-lg bg-gray-50 hover:bg-gray-100 group hover:shadow dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="30" height="30" viewBox="0 0 48 48">
                                <defs><linearGradient id="3jXOdEohtKfkAeVV9N72va_FkQHNSmqWQWH_gr1" x1="-792" x2="-792" y1="6" y2="42" gradientTransform="translate(816)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#87eb78"></stop><stop offset="1" stop-color="#29d112"></stop></linearGradient><radialGradient id="3jXOdEohtKfkAeVV9N72vb_FkQHNSmqWQWH_gr2" cx="-792" cy="24" r="18" gradientTransform="translate(816)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#7beb6c" stop-opacity="0"></stop><stop offset=".4" stop-color="#7aea6b" stop-opacity=".01"></stop><stop offset=".544" stop-color="#76e867" stop-opacity=".048"></stop><stop offset=".647" stop-color="#70e560" stop-opacity=".114"></stop><stop offset=".73" stop-color="#67df56" stop-opacity=".209"></stop><stop offset=".801" stop-color="#5ad84a" stop-opacity=".332"></stop><stop offset=".864" stop-color="#4cd03a" stop-opacity=".484"></stop><stop offset=".921" stop-color="#3ac628" stop-opacity=".665"></stop><stop offset=".972" stop-color="#26ba13" stop-opacity=".868"></stop><stop offset="1" stop-color="#19b305"></stop></radialGradient></defs><circle cx="24" cy="24" r="18" fill="url(#3jXOdEohtKfkAeVV9N72va_FkQHNSmqWQWH_gr1)"></circle><circle cx="24" cy="24" r="18" fill="url(#3jXOdEohtKfkAeVV9N72vb_FkQHNSmqWQWH_gr2)"></circle>
                            </svg>
                            <span class="flex-1 ms-3 whitespace-nowrap">COMPLETE</span>
                        </a>
                    {% else %}
                        <a href="#" class="flex items-center p-3 text-base font-bold text-gray-900 rounded-lg bg-gray-50 hover:bg-gray-100 group hover:shadow dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="30" height="30" viewBox="0 0 48 48">
                                <defs><linearGradient id="JDIk~1b93VJ5iqgYURjy0a_SCY7gqvxY0DC_gr1" x1="-792" x2="-792" y1="6" y2="42" gradientTransform="translate(816)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#829fff"></stop><stop offset="1" stop-color="#1341d6"></stop></linearGradient><radialGradient id="JDIk~1b93VJ5iqgYURjy0b_SCY7gqvxY0DC_gr2" cx="-792" cy="24" r="18" gradientTransform="translate(816)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#7595ff" stop-opacity="0"></stop><stop offset=".406" stop-color="#7494fe" stop-opacity=".011"></stop><stop offset=".553" stop-color="#6f8ffa" stop-opacity=".052"></stop><stop offset=".657" stop-color="#6788f4" stop-opacity=".123"></stop><stop offset=".741" stop-color="#5c7deb" stop-opacity=".225"></stop><stop offset=".813" stop-color="#4d6fdf" stop-opacity=".358"></stop><stop offset=".877" stop-color="#3b5ed1" stop-opacity=".522"></stop><stop offset=".935" stop-color="#2549bf" stop-opacity=".717"></stop><stop offset=".987" stop-color="#0c32ac" stop-opacity=".936"></stop><stop offset="1" stop-color="#052ba6"></stop></radialGradient></defs><circle cx="24" cy="24" r="18" fill="url(#JDIk~1b93VJ5iqgYURjy0a_SCY7gqvxY0DC_gr1)"></circle><circle cx="24" cy="24" r="18" fill="url(#JDIk~1b93VJ5iqgYURjy0b_SCY7gqvxY0DC_gr2)" opacity=".5"></circle>
                            </svg>
                            <span class="flex-1 ms-3 whitespace-nowrap">NOT STARTED</span>
                        </a>
                    {% endif %}
                </div>
            </div>
            <!-- Progress Chart -->
            <div class="grid grid-cols-2 gap-4 mb-4 mt-5">
                <div class="flex justify-center items-center rounded bg-gray-100 dark:bg-gray-800">
                    <div style="height: 400px;" class="w-full">
                        <canvas id="myChart"></canvas>
                    </div>
                </div>
                <div class="flex flex-col items-center justify-center rounded bg-gray-100 dark:bg-gray-800">
                    <p id="todayTime" class="text-center text-2xl mt-5 font-bold"></p>
                    <div style="height: 200px;">
                        <canvas id="doughnutChart"></canvas>
                    </div>
                    <div class="flex items-center justify-center rounded bg-gray-100 dark:bg-gray-800">
                        <svg id="upArrow" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="40" height="40" viewBox="0,0,256,256" style="fill:#000000;">
                            <g fill="#00a80b" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><g transform="scale(5.33333,5.33333)"><path d="M24,3l14,16h-28z"></path><path d="M19,17h10v26h-10z"></path></g></g>
                        </svg>
                        <svg id="downArrow" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="40" height="40" viewBox="0,0,256,256" style="fill:#000000;">
                            <g fill="#656565" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><g transform="scale(5.33333,5.33333)"><path d="M24,44l-14,-16h28z"></path><path d="M19,4h10v26h-10z"></path></g></g>
                        </svg>
                        <p id="percentage" class="text-center text-2xl"><strong></strong></p>
                    </div>
                </div>
                <div class="flex items-center justify-center rounded bg-gray-100 h-28 dark:bg-gray-800">
                    <div style="height: 300px; width: 400px;">
                    </div>
                </div>
                <div class="flex items-center justify-center rounded bg-gray-100 h-28 dark:bg-gray-800">
                    <div style="height: 300px; width: 400px;">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
function fetchUserScormStatus() {
    // Get the client.id, scorm.id, user.learner_id, and client.domains from the Django context
    var clientId = "{{ client.id }}";
    var scormId = "{{ scorm.id }}";
    var learnerId = "{{ user.learner_id }}";
    var referringUrl = "{{ client.domains }}";

    // Construct the id parameter
    var id = btoa(clientId + "-" + scormId);

    // Construct the URL for the API call
    var url = "/api/user_scorm_status/?id=" + id + "&learner_id=" + learnerId + "&referringurl=" + referringUrl;

    // Make the API call
    fetch(url)
        .then(response => response.json())
        .then(data => {
            // Handle the data from the API call
            console.log(data);
        })
        .catch(error => {
            // Handle any errors from the API call
            console.error('Error:', error);
        });
}

// Call the function immediately
fetchUserScormStatus();

// Set an interval to call the function every 10 minutes
setInterval(fetchUserScormStatus, 10 * 60 * 1000);
</script>    
<script>
    const user_scorm_status_id = {{ scorm_status.id }};
    const chartCtx = document.getElementById('myChart').getContext('2d');

    const myChart = new Chart(chartCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Hours Spent on SCORM per Day',
                data: [],
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    labels: {
                        font: {
                            size: 18,
                            weight: 'bold',
                            family: 'Arial'
                        },
                        color: 'rgb(0, 0, 0)'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let value = context.parsed.y;  // Get the hours value
                            return formatTime(value);     // Call the formatTime function
                        }
                    }
                }
            }
        }
    });

    function updateChart() {
        fetch(`/api/fetch_user_scorm_status_chart_data/${user_scorm_status_id}/`)
            .then(response => response.json())
            .then(data => {
                myChart.data.labels = data.labels;
                myChart.data.datasets[0].data = data.data;
                myChart.update();
            });
    }
    
    function formatTime(totalHours) {
        const hours = Math.floor(totalHours);
        const minutes = Math.round((totalHours - hours) * 60);
        return `${hours} hr ${minutes} min`; 
    }

    updateChart();  // Initial chart update
    setInterval(updateChart, 300000); // Update every 5 minutes
</script>
<script>
function calculatePercentageChange(userScormStatusId) {
  return fetch(`/api/user_scorm_status_json/${userScormStatusId}/`)
    .then(response => response.json())
    .then(data => {
      const todayTimes = [];
      const yesterdayTimes = [];
      const todayTotalTimes = [];
      const yesterdayTotalTimes = [];

      const today = new Date().toISOString().split('T')[0];
      const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      
      console.log('TodayTimes:', todayTimes);
      console.log('YesterdayTimes:', yesterdayTimes);

      data.updated_at.forEach(entry => {
            const date = entry.updated_at.split(' ')[0];
            const timeParts = entry.total_time.split(':');
            const hours = parseFloat(timeParts[0]);
            const minutes = parseFloat(timeParts[1]) / 60;  // Convert minutes to hours
            const seconds = parseFloat(timeParts[2]) / 3600;  // Convert seconds to hours
            const totalTime = hours + minutes + seconds;
        
            if (date === today) {
              todayTimes.push(totalTime);
              todayTotalTimes.push(entry.total_time);
            } else if (date === yesterday) {
              yesterdayTimes.push(totalTime);
              yesterdayTotalTimes.push(entry.total_time);
            }
        });
      
      console.log('TodayTotalTimes:', todayTotalTimes);
        console.log('YesterdayTotalTimes:', yesterdayTotalTimes);
      
      let maxTodayTime = Math.max(...todayTimes);
      let maxYesterdayTime = Math.max(...yesterdayTimes);

      const maxTodayTotalTime = todayTotalTimes.length > 0 ? todayTotalTimes[todayTotalTimes.length - 1] : "00:00:00.00";
      const maxYesterdayTotalTime = yesterdayTotalTimes.length > 0 ? yesterdayTotalTimes[yesterdayTotalTimes.length - 1] : "00:00:00.00";
      
      if (maxYesterdayTime === -Infinity) {
        maxYesterdayTime = 0;
      }
      if (maxTodayTime === -Infinity) {
        maxTodayTime = 0;
      }

      let percentageChange;
      if (maxYesterdayTime === 0 && maxTodayTime > 0) {
        percentageChange = 100;
      } else if (maxTodayTime === 0 && maxYesterdayTime > 0) {
        percentageChange = -100;
      } else if (maxTodayTime === 0 && maxYesterdayTime === 0) {
        percentageChange = 0;
      } else {
        percentageChange = ((maxTodayTime - maxYesterdayTime) / maxYesterdayTime) * 100;
      }
      
      const result = {
        percentageChange: percentageChange.toFixed(2),
        maxTodayTime: maxTodayTime,
        maxYesterdayTime: maxYesterdayTime,
        maxTodayTotalTime: maxTodayTotalTime,  
        maxYesterdayTotalTime: maxYesterdayTotalTime,
      };
      
      console.log('Result:', result);

      return result;
    })
    .catch(error => {
      console.error('Error:', error);
    });
}

calculatePercentageChange({{ scorm_status.id }}).then(result => {
console.log('Result:', result);  
  const data = {
    datasets: [{
      data: [Math.abs(result.percentageChange), 100 - Math.abs(result.percentageChange)],
      backgroundColor: [result.percentageChange >= 0 ? 'green' : 'red', 'lightgray']
    }]
  };
  
  console.log('Data:', data);

  const config = {
    type: 'doughnut',
    data: data,
    options: {
      rotation: -90, // Start angle at 12 o'clock
      circumference: 180, // Display only a half-circle
      cutout: '80%', // Make it a ring
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          enabled: false
        },
      },
    }
  };

  const doughnutChart = new Chart(
    document.getElementById('doughnutChart'), // Replace with your chart container ID
    config
  );

  let changeText = result.percentageChange >= 0 ? 'Increase' : 'Decrease';
document.getElementById('percentage').innerText = `${result.percentageChange}% ${changeText}`;
  
    // Select the SVG elements
    const upArrow = document.getElementById('upArrow');
    const downArrow = document.getElementById('downArrow');
    
    if (result.percentageChange >= 0) {
        // If the percentage change is non-negative, show the up arrow and hide the down arrow
        upArrow.style.display = 'block';
        downArrow.style.display = 'none';
    } else {
        // If the percentage change is negative, hide the up arrow and show the down arrow
        upArrow.style.display = 'none';
        downArrow.style.display = 'block';
    }
  
  function formatTime(timeString) {
      const parts = timeString.split(':');
      const hours = parseInt(parts[0], 10);
      const minutes = parseInt(parts[1], 10);
      const seconds = parseInt(parts[2], 10);
    
      return `${hours}hr ${minutes}min ${seconds}sec`;
  }

  // Select the p element with id "todayTime" and set its text content
  document.getElementById('todayTime').innerText = formatTime(result.maxTodayTotalTime) + ' Today';
});
</script>
{% endblock %}